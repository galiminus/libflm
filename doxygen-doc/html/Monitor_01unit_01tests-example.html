<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>libflm-0.3: Monitor unit tests</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="libflm.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = 'open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = 'closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">libflm-0.3&#160;<span id="projectnumber">0.3</span></div>
   <div id="projectbrief">A simple event-driven IO library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Monitor unit tests</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;check.h&gt;</span>

<span class="preprocessor">#include &quot;flm/flm.h&quot;</span>
<span class="preprocessor">#include &quot;flm/core/private/monitor.h&quot;</span>

<span class="preprocessor">#include &quot;test_utils.h&quot;</span>

START_TEST(test_monitor_create)
{
    flm_Monitor * monitor;

    <span class="keywordflow">if</span> ((monitor = <a name="a0"></a><a class="code" href="monitor_8h.html#a9ac7adccec16433fe0acbc6a9570aec9" title="Create a new flm_Monitor object.">flm_MonitorNew</a> ()) == NULL) {
        fail (<span class="stringliteral">&quot;Monitor creation failed&quot;</span>);
    }
    fail_unless (monitor-&gt;io.count == 0);
    fail_unless (monitor-&gt;tm.count == 0);
    fail_unless (monitor-&gt;tm.pos == 0);
}
END_TEST

START_TEST(test_monitor_bad_backend)
{
    setTestAlloc (0);
    flm__setMonitorBackend (FLM__MONITOR_BACKEND_NONE);
    fail_if (<a class="code" href="monitor_8h.html#a9ac7adccec16433fe0acbc6a9570aec9" title="Create a new flm_Monitor object.">flm_MonitorNew</a> () != NULL);
    fail_unless (getAllocSum () == 0);
    fail_unless (<a name="a1"></a><a class="code" href="error_8h.html#ad1766173eeafcea6be9be3c16c30fb95" title="Return last error code.">flm_Error</a> () == <a name="a2"></a><a class="code" href="error_8h.html#a9d9ce0322d33a2cf7912aec85755e04ea2680442890d5e85e4e74366827a0c8e5">FLM_ERR_NOSYS</a>);
}
END_TEST

START_TEST(test_monitor_alloc_fail)
{
    setTestAlloc (1);
    fail_if (<a class="code" href="monitor_8h.html#a9ac7adccec16433fe0acbc6a9570aec9" title="Create a new flm_Monitor object.">flm_MonitorNew</a> () != NULL);
    fail_unless (getAllocSum () == 0);
    fail_unless (<a class="code" href="error_8h.html#ad1766173eeafcea6be9be3c16c30fb95" title="Return last error code.">flm_Error</a> () == <a name="a3"></a><a class="code" href="error_8h.html#a9d9ce0322d33a2cf7912aec85755e04ea9b1385085173bd9ce040f2cfe6246f38">FLM_ERR_NOMEM</a>);

    setTestAlloc (2);
    fail_if (<a class="code" href="monitor_8h.html#a9ac7adccec16433fe0acbc6a9570aec9" title="Create a new flm_Monitor object.">flm_MonitorNew</a> () != NULL);
    fail_unless (getAllocSum () == 0);
    fail_unless (<a class="code" href="error_8h.html#ad1766173eeafcea6be9be3c16c30fb95" title="Return last error code.">flm_Error</a> () == <a class="code" href="error_8h.html#a9d9ce0322d33a2cf7912aec85755e04ea9b1385085173bd9ce040f2cfe6246f38">FLM_ERR_NOMEM</a>);
}
END_TEST

<span class="keywordtype">int</span>
_gettime_handler (<span class="keywordtype">int</span>                   type,
                  <span class="keyword">struct</span> timespec *     timespec)
{
    (void) type;
    (void) timespec;

    <span class="keywordflow">return</span> (-1);
}

START_TEST(test_monitor_gettime_fail)
{
    setTestAlloc (0);
    flm__setMonitorClockGettime (_gettime_handler);
    fail_if (<a class="code" href="monitor_8h.html#a9ac7adccec16433fe0acbc6a9570aec9" title="Create a new flm_Monitor object.">flm_MonitorNew</a> () != NULL);
    fail_unless (getAllocSum () == 0);
}
END_TEST

START_TEST(test_monitor_destruct)
{
    flm_Monitor * monitor;

    setTestAlloc (0);
    <span class="keywordflow">if</span> ((monitor = <a class="code" href="monitor_8h.html#a9ac7adccec16433fe0acbc6a9570aec9" title="Create a new flm_Monitor object.">flm_MonitorNew</a> ()) == NULL) {
        fail (<span class="stringliteral">&quot;Monitor creation failed&quot;</span>);
    }
    <a name="a4"></a><a class="code" href="monitor_8h.html#a8a00c66f9e90881a0ef4623ec0dbd9ad" title="Decrement the reference counter.">flm_MonitorRelease</a> (monitor);
    fail_unless (getAllocSum () == 0);
}
END_TEST

START_TEST(test_monitor_wait_nothing)
{
    flm_Monitor * monitor;

    setTestAlloc (0);
    <span class="keywordflow">if</span> ((monitor = <a class="code" href="monitor_8h.html#a9ac7adccec16433fe0acbc6a9570aec9" title="Create a new flm_Monitor object.">flm_MonitorNew</a> ()) == NULL) {
        fail (<span class="stringliteral">&quot;Monitor creation failed&quot;</span>);
    }
    <span class="keywordflow">if</span> (<a name="a5"></a><a class="code" href="monitor_8h.html#ae0cdcfb013a0acca6b1e740d5d4086b7" title="Wait for events.">flm_MonitorWait</a> (monitor) == -1) {
        fail (<span class="stringliteral">&quot;Monitor wait failed&quot;</span>);
    }
    <a class="code" href="monitor_8h.html#a8a00c66f9e90881a0ef4623ec0dbd9ad" title="Decrement the reference counter.">flm_MonitorRelease</a> (monitor);
    fail_unless (getAllocSum () == 0);
}
END_TEST

START_TEST(test_monitor_wait)
{
    flm_Monitor *       monitor;
    flm_Timer *         timer;
    <span class="keyword">struct </span>timeval      start;
    <span class="keyword">struct </span>timeval      end;

    setTestAlloc (0);
    <span class="keywordflow">if</span> ((monitor = <a class="code" href="monitor_8h.html#a9ac7adccec16433fe0acbc6a9570aec9" title="Create a new flm_Monitor object.">flm_MonitorNew</a> ()) == NULL) {
        fail (<span class="stringliteral">&quot;Monitor creation failed&quot;</span>);
    }

    timer = <a name="a6"></a><a class="code" href="timer_8h.html#af21a94f6ef9e64cc0ec4d47fef11d258" title="Create a new timer.">flm_TimerNew</a> (monitor, NULL, NULL, 1500);
    <span class="keywordflow">if</span> (timer == NULL) {
        fail (<span class="stringliteral">&quot;Timer creation failed&quot;</span>);
    }
    fail_unless (monitor-&gt;tm.count == 1);
    <a name="a7"></a><a class="code" href="timer_8h.html#af24321f27e1afe647729a6342fb80447" title="Decrement the reference counter.">flm_TimerRelease</a> (timer);

    <span class="keywordflow">if</span> (gettimeofday (&amp;start, NULL) == -1) {
        fail (<span class="stringliteral">&quot;gettimeofday() failed&quot;</span>);
    }

    <span class="keywordflow">if</span> (<a class="code" href="monitor_8h.html#ae0cdcfb013a0acca6b1e740d5d4086b7" title="Wait for events.">flm_MonitorWait</a> (monitor) == -1) {
        fail (<span class="stringliteral">&quot;Monitor wait failed&quot;</span>);
    }
    <a class="code" href="monitor_8h.html#a8a00c66f9e90881a0ef4623ec0dbd9ad" title="Decrement the reference counter.">flm_MonitorRelease</a> (monitor);

    <span class="keywordflow">if</span> (gettimeofday (&amp;end, NULL) == -1) {
        fail (<span class="stringliteral">&quot;gettimeofday() failed&quot;</span>);
    }

    fail_if ((end.tv_sec - start.tv_sec) &lt; 1);
    fail_unless (getAllocSum () == 0);
}
END_TEST

START_TEST(test_monitor_wait_gettime_fail)
{
    flm_Monitor *       monitor;
    flm_Timer *         timer;
    <span class="keyword">struct </span>timeval      start;
    <span class="keyword">struct </span>timeval      end;

    setTestAlloc (0);

    <span class="keywordflow">if</span> ((monitor = <a class="code" href="monitor_8h.html#a9ac7adccec16433fe0acbc6a9570aec9" title="Create a new flm_Monitor object.">flm_MonitorNew</a> ()) == NULL) {
        fail (<span class="stringliteral">&quot;Monitor creation failed&quot;</span>);
    }

    timer = <a class="code" href="timer_8h.html#af21a94f6ef9e64cc0ec4d47fef11d258" title="Create a new timer.">flm_TimerNew</a> (monitor, NULL, NULL, 1500);
    <span class="keywordflow">if</span> (timer == NULL) {
        fail (<span class="stringliteral">&quot;Timer creation failed&quot;</span>);
    }
    fail_unless (monitor-&gt;tm.count == 1);
    <a class="code" href="timer_8h.html#af24321f27e1afe647729a6342fb80447" title="Decrement the reference counter.">flm_TimerRelease</a> (timer);

    <span class="keywordflow">if</span> (gettimeofday (&amp;start, NULL) == -1) {
        fail (<span class="stringliteral">&quot;gettimeofday() failed&quot;</span>);
    }

    flm__setMonitorClockGettime (_gettime_handler);

    fail_unless (<a class="code" href="monitor_8h.html#ae0cdcfb013a0acca6b1e740d5d4086b7" title="Wait for events.">flm_MonitorWait</a> (monitor) == -1);
    fail_unless (<a class="code" href="error_8h.html#ad1766173eeafcea6be9be3c16c30fb95" title="Return last error code.">flm_Error</a> () == <a name="a8"></a><a class="code" href="error_8h.html#a9d9ce0322d33a2cf7912aec85755e04ea5fd1acb896d913dddb2ebce92d95153d">FLM_ERR_ERRNO</a>);
    <a class="code" href="monitor_8h.html#a8a00c66f9e90881a0ef4623ec0dbd9ad" title="Decrement the reference counter.">flm_MonitorRelease</a> (monitor);

    <span class="keywordflow">if</span> (gettimeofday (&amp;end, NULL) == -1) {
        fail (<span class="stringliteral">&quot;gettimeofday() failed&quot;</span>);
    }

    fail_if ((end.tv_sec - start.tv_sec) &lt; 1);
    fail_unless (getAllocSum () == 0);
}
END_TEST

<span class="keywordtype">void</span>
_stream_read_handler (flm_Stream *  stream,
                      <span class="keywordtype">void</span> *        state,
                      flm_Buffer *  buffer)
{
    fail_unless (state == (<span class="keywordtype">void</span> *) 42);
    fail_unless (<a name="a9"></a><a class="code" href="buffer_8h.html#a0f653e9b60cd021dff1d781b5626b4d0" title="Returns the length (in bytes) of the buffer.">flm_BufferLength</a> (buffer) == 1);
    fail_unless (<a name="a10"></a><a class="code" href="buffer_8h.html#ae49cf4df7d43396a0fd95cc0a9795dd7" title="Returns the content of the buffer.">flm_BufferContent</a> (buffer)[0] == <span class="charliteral">&#39;a&#39;</span>);
    <a name="a11"></a><a class="code" href="buffer_8h.html#a39271099b1606b4154553f9442011db7" title="Decrement the reference counter.">flm_BufferRelease</a> (buffer);
    <a name="a12"></a><a class="code" href="stream_8h.html#a1a5e35800f405a10bc937b0d96bcd25a">flm_StreamClose</a> (stream);
    return ;
}

<span class="keywordtype">void</span>
_stream_write_handler (flm_Stream *  stream,
                       <span class="keywordtype">void</span> *        state,
                       <span class="keywordtype">size_t</span>        size)
{
    fail_unless (state == (<span class="keywordtype">void</span> *) 42);
    fail_unless (size == 1);
    <a class="code" href="stream_8h.html#a1a5e35800f405a10bc937b0d96bcd25a">flm_StreamClose</a> (stream);
    return ;
}

START_TEST(test_monitor_wait_io)
{
    flm_Monitor *       monitor;
    flm_Stream *        read;
    flm_Stream *        write;
    <span class="keywordtype">int</span>                 fds[2];

    setTestAlloc (0);
    <span class="keywordflow">if</span> ((monitor = <a class="code" href="monitor_8h.html#a9ac7adccec16433fe0acbc6a9570aec9" title="Create a new flm_Monitor object.">flm_MonitorNew</a> ()) == NULL) {
        fail (<span class="stringliteral">&quot;Monitor creation failed&quot;</span>);
    }

    <span class="keywordflow">if</span> (pipe (fds) == -1) {
        fail (<span class="stringliteral">&quot;Pipe creation failed&quot;</span>);
    }

    read = <a name="a13"></a><a class="code" href="stream_8h.html#ac89ebf8bef6afa634e7097060d4988d9">flm_StreamNew</a> (monitor, fds[0], (<span class="keywordtype">void</span> *) 42);
    <span class="keywordflow">if</span> (read == NULL) {
        fail (<span class="stringliteral">&quot;Stream (read) creation failed&quot;</span>);
    }

    <a name="a14"></a><a class="code" href="stream_8h.html#a87cf04647e6d86a1037876f2093f949d">flm_StreamOnRead</a> (read, _stream_read_handler);

    fail_unless (monitor-&gt;io.count == 1);
    <a name="a15"></a><a class="code" href="stream_8h.html#ada4474f10a2c8e7d97b27c983d56ef6c">flm_StreamRelease</a> (read);

    write = <a class="code" href="stream_8h.html#ac89ebf8bef6afa634e7097060d4988d9">flm_StreamNew</a> (monitor, fds[1], (<span class="keywordtype">void</span> *) 42);
    <span class="keywordflow">if</span> (write == NULL) {
        fail (<span class="stringliteral">&quot;Stream (write) creation failed&quot;</span>);
    }

    <a name="a16"></a><a class="code" href="stream_8h.html#a6b92f4a44789145b5922c13c14f30af3">flm_StreamOnWrite</a> (write, _stream_write_handler);
    <a name="a17"></a><a class="code" href="stream_8h.html#af82bbe9b6534bd640bad977106fba5d0">flm_StreamPrintf</a> (write, <span class="stringliteral">&quot;a&quot;</span>);

    fail_unless (monitor-&gt;io.count == 2);
    <a class="code" href="stream_8h.html#ada4474f10a2c8e7d97b27c983d56ef6c">flm_StreamRelease</a> (write);

    <span class="keywordflow">if</span> (<a class="code" href="monitor_8h.html#ae0cdcfb013a0acca6b1e740d5d4086b7" title="Wait for events.">flm_MonitorWait</a> (monitor) == -1) {
        fail (<span class="stringliteral">&quot;Monitor wait failed&quot;</span>);
    }
    <a class="code" href="monitor_8h.html#a8a00c66f9e90881a0ef4623ec0dbd9ad" title="Decrement the reference counter.">flm_MonitorRelease</a> (monitor);

    fail_unless (getAllocSum () == 0);
}
END_TEST

Suite *
monitor_suite (<span class="keywordtype">void</span>)
{
  Suite * s = suite_create (<span class="stringliteral">&quot;monitor&quot;</span>);

  <span class="comment">/* Core test case */</span>
  TCase *tc_core = tcase_create (<span class="stringliteral">&quot;Core&quot;</span>);
  tcase_add_test (tc_core, test_monitor_create);
  tcase_add_test (tc_core, test_monitor_bad_backend);
  tcase_add_test (tc_core, test_monitor_alloc_fail);
  tcase_add_test (tc_core, test_monitor_gettime_fail);
  tcase_add_test (tc_core, test_monitor_destruct);
  tcase_add_test (tc_core, test_monitor_wait_nothing);
  tcase_add_test (tc_core, test_monitor_wait);
  tcase_add_test (tc_core, test_monitor_wait_gettime_fail);
  tcase_add_test (tc_core, test_monitor_wait_io);
  suite_add_tcase (s, tc_core);
  <span class="keywordflow">return</span> s;
}
</pre></div><div class="fragment"><pre class="fragment"></pre></div><p> unit tests </p>
</div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu Mar 17 2011 for libflm-0.3 by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>

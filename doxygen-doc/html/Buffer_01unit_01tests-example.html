<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>libflm-0.3: Buffer unit tests</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="libflm.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = 'open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = 'closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">libflm-0.3&#160;<span id="projectnumber">0.3</span></div>
   <div id="projectbrief">A simple event-driven IO library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Buffer unit tests</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;check.h&gt;</span>

<span class="preprocessor">#include &quot;flm/flm.h&quot;</span>

<span class="preprocessor">#include &quot;test_utils.h&quot;</span>

START_TEST(test_buffer_create)
{
    <span class="keywordflow">if</span> (<a name="a0"></a><a class="code" href="buffer_8h.html#aea3900024acc8e312908700d8a1a10d7" title="Create a new buffer from an existing chunk of memory.">flm_BufferNew</a> (<span class="stringliteral">&quot;&quot;</span>, 0, NULL) == NULL) {
        fail (<span class="stringliteral">&quot;Buffer creation failed&quot;</span>);
    }
}
END_TEST

START_TEST(test_buffer_printf)
{
    flm_Buffer * buffer;

    <span class="keywordflow">if</span> ((buffer = <a name="a1"></a><a class="code" href="buffer_8h.html#ab61a6cc4cf71e9935ea41691c5203fe6" title="Create a new flm_Buffer object and fill it with a formatted string.">flm_BufferPrintf</a> (<span class="stringliteral">&quot;TEST %d %s &quot;</span>, 42, <span class="stringliteral">&quot;coucou&quot;</span>)) == NULL) {
        fail (<span class="stringliteral">&quot;Buffer creation failed&quot;</span>);
    }
    fail_unless (strcmp (<a name="a2"></a><a class="code" href="buffer_8h.html#ae49cf4df7d43396a0fd95cc0a9795dd7" title="Returns the content of the buffer.">flm_BufferContent</a> (buffer), <span class="stringliteral">&quot;TEST 42 coucou &quot;</span>) == 0);
}
END_TEST

START_TEST(test_buffer_content)
{
    flm_Buffer * buffer;
    
    <span class="keywordflow">if</span> ((buffer = <a class="code" href="buffer_8h.html#aea3900024acc8e312908700d8a1a10d7" title="Create a new buffer from an existing chunk of memory.">flm_BufferNew</a> (<span class="stringliteral">&quot;test&quot;</span>, 5, NULL)) == NULL) {
        fail (<span class="stringliteral">&quot;Buffer creation failed&quot;</span>);
    }
    fail_unless (strcmp (<a class="code" href="buffer_8h.html#ae49cf4df7d43396a0fd95cc0a9795dd7" title="Returns the content of the buffer.">flm_BufferContent</a> (buffer), <span class="stringliteral">&quot;test&quot;</span>) == 0);
}
END_TEST

START_TEST(test_buffer_length)
{
    flm_Buffer * buffer;
    
    <span class="keywordflow">if</span> ((buffer = <a class="code" href="buffer_8h.html#aea3900024acc8e312908700d8a1a10d7" title="Create a new buffer from an existing chunk of memory.">flm_BufferNew</a> (<span class="stringliteral">&quot;test&quot;</span>, 4, NULL)) == NULL) {
        fail (<span class="stringliteral">&quot;Buffer creation failed&quot;</span>);
    }
    <span class="keywordflow">if</span> (<a name="a3"></a><a class="code" href="buffer_8h.html#a0f653e9b60cd021dff1d781b5626b4d0" title="Returns the length (in bytes) of the buffer.">flm_BufferLength</a> (buffer) != 4) {
        fail (<span class="stringliteral">&quot;Invalid buffer content&quot;</span>);
    }
}
END_TEST

START_TEST(test_buffer_printf_length)
{
    flm_Buffer * buffer;
    
    <span class="keywordflow">if</span> ((buffer = <a class="code" href="buffer_8h.html#ab61a6cc4cf71e9935ea41691c5203fe6" title="Create a new flm_Buffer object and fill it with a formatted string.">flm_BufferPrintf</a> (<span class="stringliteral">&quot;TEST %d %s &quot;</span>, 42, <span class="stringliteral">&quot;coucou&quot;</span>)) == NULL) {
        fail (<span class="stringliteral">&quot;Buffer creation failed&quot;</span>);
    }
    <span class="keywordflow">if</span> (<a class="code" href="buffer_8h.html#a0f653e9b60cd021dff1d781b5626b4d0" title="Returns the length (in bytes) of the buffer.">flm_BufferLength</a> (buffer) != 15) {
        fail (<span class="stringliteral">&quot;Invalid buffer content&quot;</span>);
    }
}
END_TEST

<span class="keywordtype">int</span> _has_freed;

<span class="keywordtype">void</span>
_buffer_free_handler (<span class="keywordtype">void</span> * content) {
    (void) content;
    _has_freed = 1;
}

START_TEST(test_buffer_free)
{
    flm_Buffer * buffer;
    
    setTestAlloc (0);
    _has_freed = 0;
    <span class="keywordflow">if</span> ((buffer = <a class="code" href="buffer_8h.html#aea3900024acc8e312908700d8a1a10d7" title="Create a new buffer from an existing chunk of memory.">flm_BufferNew</a> (<span class="stringliteral">&quot;test&quot;</span>, 5, _buffer_free_handler)) == NULL) {
        fail (<span class="stringliteral">&quot;Buffer creation failed&quot;</span>);
    }
    <a name="a4"></a><a class="code" href="buffer_8h.html#a39271099b1606b4154553f9442011db7" title="Decrement the reference counter.">flm_BufferRelease</a> (buffer);
    fail_if(_has_freed == 0);
    fail_unless (getAllocSum () == 0);
}
END_TEST

START_TEST(test_buffer_alloc_fail)
{
    setTestAlloc (1);
    fail_if (<a class="code" href="buffer_8h.html#aea3900024acc8e312908700d8a1a10d7" title="Create a new buffer from an existing chunk of memory.">flm_BufferNew</a> (<span class="stringliteral">&quot;test&quot;</span>, 5, NULL) != NULL);
    fail_unless (getAllocSum () == 0);
    fail_unless (<a name="a5"></a><a class="code" href="error_8h.html#ad1766173eeafcea6be9be3c16c30fb95" title="Return last error code.">flm_Error</a> () == <a name="a6"></a><a class="code" href="error_8h.html#a9d9ce0322d33a2cf7912aec85755e04ea9b1385085173bd9ce040f2cfe6246f38">FLM_ERR_NOMEM</a>);

    setTestAlloc (1);
    fail_if (<a class="code" href="buffer_8h.html#ab61a6cc4cf71e9935ea41691c5203fe6" title="Create a new flm_Buffer object and fill it with a formatted string.">flm_BufferPrintf</a> (<span class="stringliteral">&quot;test&quot;</span>) != NULL);
    fail_unless (getAllocSum () == 0);
    fail_unless (<a class="code" href="error_8h.html#ad1766173eeafcea6be9be3c16c30fb95" title="Return last error code.">flm_Error</a> () == <a class="code" href="error_8h.html#a9d9ce0322d33a2cf7912aec85755e04ea9b1385085173bd9ce040f2cfe6246f38">FLM_ERR_NOMEM</a>);

    setTestAlloc (2);
    fail_if (<a class="code" href="buffer_8h.html#ab61a6cc4cf71e9935ea41691c5203fe6" title="Create a new flm_Buffer object and fill it with a formatted string.">flm_BufferPrintf</a> (<span class="stringliteral">&quot;test&quot;</span>) != NULL);
    fail_unless (getAllocSum () == 0);
    fail_unless (<a class="code" href="error_8h.html#ad1766173eeafcea6be9be3c16c30fb95" title="Return last error code.">flm_Error</a> () == <a class="code" href="error_8h.html#a9d9ce0322d33a2cf7912aec85755e04ea9b1385085173bd9ce040f2cfe6246f38">FLM_ERR_NOMEM</a>);
}
END_TEST

START_TEST(test_buffer_destruct)
{
    flm_Buffer * buffer;

    setTestAlloc (0);
    <span class="keywordflow">if</span> ((buffer = <a class="code" href="buffer_8h.html#aea3900024acc8e312908700d8a1a10d7" title="Create a new buffer from an existing chunk of memory.">flm_BufferNew</a> (<span class="stringliteral">&quot;test&quot;</span>, 5, NULL)) == NULL) {
        fail (<span class="stringliteral">&quot;Buffer creation failed&quot;</span>);
    }
    <a class="code" href="buffer_8h.html#a39271099b1606b4154553f9442011db7" title="Decrement the reference counter.">flm_BufferRelease</a> (buffer);
    fail_unless (getAllocSum () == 0);

    <span class="keywordflow">if</span> ((buffer = <a class="code" href="buffer_8h.html#aea3900024acc8e312908700d8a1a10d7" title="Create a new buffer from an existing chunk of memory.">flm_BufferNew</a> (<span class="stringliteral">&quot;test&quot;</span>, 5, NULL)) == NULL) {
        fail (<span class="stringliteral">&quot;Buffer creation failed&quot;</span>);
    }
    <a class="code" href="buffer_8h.html#a39271099b1606b4154553f9442011db7" title="Decrement the reference counter.">flm_BufferRelease</a> (buffer);
    fail_unless (getAllocSum () == 0);
}
END_TEST

Suite *
buffer_suite (<span class="keywordtype">void</span>)
{
  Suite * s = suite_create (<span class="stringliteral">&quot;buffer&quot;</span>);

  <span class="comment">/* Core test case */</span>
  TCase *tc_core = tcase_create (<span class="stringliteral">&quot;Core&quot;</span>);
  tcase_add_test (tc_core, test_buffer_create);
  tcase_add_test (tc_core, test_buffer_printf);
  tcase_add_test (tc_core, test_buffer_content);
  tcase_add_test (tc_core, test_buffer_length);
  tcase_add_test (tc_core, test_buffer_printf_length);
  tcase_add_test (tc_core, test_buffer_free);
  tcase_add_test (tc_core, test_buffer_alloc_fail);
  tcase_add_test (tc_core, test_buffer_destruct);
  suite_add_tcase (s, tc_core);

  <span class="keywordflow">return</span> s;
}

</pre></div><div class="fragment"><pre class="fragment"></pre></div><p> unit tests </p>
</div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu Mar 17 2011 for libflm-0.3 by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
